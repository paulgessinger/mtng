{% if full_tex %}
{% extends "base.tex" %}
{% endif %}

{% block body %}

\providecommand{\prmerged}{MERGED }
\providecommand{\propen}{OPEN }
\providecommand{\prwip}{WIP }
\providecommand{\prstale}{STALE }
\providecommand{\iss}{}
    
\providecolor{shivablue}{rgb}{0.6,0.86,0.99}
\providecolor{Red}{rgb}{1.0,0.18,0.09}

\providecommand{\cusemoji}[1]{}
\providecommand{\emojispace}[1]{}

{% macro date_range() %}
between {{ since.strftime('%Y-%m-%d') }} and {{ now.strftime('%Y-%m-%d') }}
{% endmacro %}

{% for repo_name, repo in repos.items() %}

{% macro show_item(item, mode = none) %}
    \item
    {%- set needs_space = false -%}
    {%- if item.is_pr -%}
      {%- set needs_space = true -%}
      {% if mode == "OPEN" %}\propen{% elif mode == "MERGED" -%}\prmerged{% endif %}
    {%- else -%}
      {%- set needs_space = true -%}
      \iss
    {%- endif -%}
    {%- if item.is_wip -%}\prwip 
    {%- set needs_space = true -%}
    {%- endif -%}
    {%- if item.is_stale -%}\prstale
    {%- set needs_space = true -%}
    {%- endif -%}
    {%- if needs_space %}
    \hspace*{0.1em}
    {% endif -%}
    \textbf{\href{
      {{- item.html_url -}}
    }{\textcolor{black}{
      {{- item.title|sanitize -}} 
    }}}
    (\href{ {{- item.html_url -}} }{
    {%- if item.is_pr -%}
    PR
    {%- else -%}
    Issue
    {%- endif -%}
    \#{{- item.number -}} }) \\
    by \href{ {{- item.user.html_url -}} }{@{{- item.user.login|sanitize -}}}, {}
    {%- if item.assignee -%}
    assigned to \href{ {{- item.assignee.html_url -}} }{@{{- item.assignee.login|sanitize -}}}
    {%- else -%}
    {%- if repo.spec.no_assignee_attention and mode != "MERGED" -%}
    \emojispace{warning}\textbf{\textcolor{Red}{no assignee}}
    {%- else -%}
    no assignee
    {%- endif -%}
    {%- endif -%}
    {{- caller() }}
{% endmacro %}

{% if repo["merged_prs"]|length > 0 %}

\section{ {{repo_name}} \\ Merged PRs}
\begin{frame}[allowframebreaks]{ {{ repo_name }}: PRs merged {{ date_range() }}}

  \begin{itemize}
    {% for pr in repo["merged_prs"]|sort(attribute="closed_at") %}
    {%- call show_item(pr, mode="MERGED") -%}
    , merged on {{ pr.closed_at.strftime('%Y-%m-%d') }}
    {%- endcall %}
    {%- endfor %}
  \end{itemize}

\end{frame}

{% else %}
\begin{frame}[c]{}
  \begin{center}
    \Large
    \color{shivablue}
    \sffamily 
    No merged PRs since \textbf{ {{ since.strftime('%Y-%m-%d') }} } in\\
    \textbf{ {{ repo_name }} }
  \end{center}
\end{frame}
{% endif %}

\section{ {{repo_name}} \\ Open PRs}
{% if repo["open_prs"]| length > 0 %}
\begin{frame}[allowframebreaks]{ {{ repo_name }}: Open PRs
}

  \begin{itemize}
    {% for wip in ["false", "true"] %}
    {% for pr in repo["open_prs"]|selectattr("is_wip", wip)|sort(reverse=True, attribute="updated_at") %}
    {%- call show_item(pr, mode="OPEN") -%}
    , updated on {{ pr.updated_at.strftime('%Y-%m-%d') }}
    {%- endcall %}
    {%- endfor %}
    {%- endfor %}
  \end{itemize}

\end{frame}
{% endif %}

{% if repo["spec"].do_recent_issues %}
{% if repo["recent_issues"] | length > 0 %}
  \section{ {{repo_name}} \\ Issues opened since {{ since.strftime('%Y-%m-%d') }} }
  \begin{frame}[allowframebreaks]{ {{ repo_name }}: Issues opened since {{ since.strftime('%Y-%m-%d') }} }
    \begin{itemize}
      {% for item in repo["recent_issues"]|sort(reverse=True, attribute="updated_at") %}
      {%- call show_item(item) -%}
          , updated on {{ item.updated_at.strftime('%Y-%m-%d') }}
      {%- endcall %}
      {%- endfor %}
      \end{itemize}
  \end{frame}
{% else %}
  \section{ {{repo_name}} \\ No issues opened since {{ since.strftime('%Y-%m-%d') }} }
{% endif %}
{% endif %}

{% if repo.spec.do_stale %}
{% set newly_stale = repo["stale"] | selectattr("updated_at", ">", since) | list %}
{% if newly_stale | length > 0 %}
\section{ {{repo_name}} \\ Stale Issues and PRs}
\begin{frame}[allowframebreaks]{ {{ repo_name }}: New stale Issues / PRs since {{ since.strftime('%Y-%m-%d') }} }
  \begin{itemize}
    {% for item in newly_stale %}
    {%- call show_item(item, mode="OPEN") -%}
        , updated on {{ item.updated_at.strftime('%Y-%m-%d') }}
    {%- endcall %}
    {%- endfor %}
  \end{itemize}
\end{frame}
{% else %}
\section{ {{repo_name}} \\ No new stale issues or PRs since {{ since.strftime('%Y-%m-%d') }} }
{% endif %}

{% if repo["stale"]|length > 0 %}
\section{ {{repo_name}} \\ All stale Issues and PRs}
\begin{frame}[allowframebreaks]{ {{ repo_name }}: All stale Issues / PRs}
  \begin{itemize}
    {% for item in repo["stale"]|sort(reverse=True, attribute="updated_at") %}
    {%- call show_item(item, mode="OPEN") -%}
        , updated on {{ item.updated_at.strftime('%Y-%m-%d') }}
    {%- endcall %}
    {%- endfor %}
  \end{itemize}
\end{frame}
{% endif %}
{% endif %}

{% endfor %}

{% if contributions|length > 0 %}
\begin{frame}[allowframebreaks]{Contributions today}
  \begin{itemize}
    {% for contrib in contributions %}

      \item
      \href{ {{- contrib["url"] -}} }{ \textbf{ {{- contrib["title"] -}} } } \\
      {% if contrib["speakers"]|length > 0 %}
      by {{ contrib["speakers"]|join(", ") }}
      {% endif %}
    {% endfor %}
  \end{itemize}
\end{frame}
{% endif %}

{% endblock %}
